{% extends 'invoice/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Commission Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-1">
        <h3 class="text-xl font-semibold tracking-tight">Commission Report</h3>
        <p class="text-sm text-muted-foreground">Track CSR commissions based on completed student admissions</p>
    </div>

    <!-- Filters Card -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="p-6 space-y-6">
            <h2 class="text-lg font-semibold leading-none tracking-tight">Commission Filters</h2>
            <form method="get" id="filterForm" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label for="start_date"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Start
                            Date</label>
                        <input type="text" id="start_date" name="start_date" placeholder="From"
                            value="{{ start_date|default:'' }}" required
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 datepicker">
                    </div>
                    <div class="space-y-2">
                        <label for="end_date"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">End
                            Date</label>
                        <input type="text" id="end_date" name="end_date" placeholder="To"
                            value="{{ end_date|default:'' }}" required
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 datepicker">
                    </div>
                    <div class="space-y-2">
                        <label for="commission_percent"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Commission
                            Percentage</label>
                        <input type="number" id="commission_percent" name="commission_percent" placeholder="10"
                            value="{{ commission_percent|default:10 }}" min="0" max="100" step="0.1"
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <p class="text-[0.8rem] text-muted-foreground">Percentage applied to discounted price</p>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="submit"
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        <i class="fas fa-calculator mr-2"></i> Calculate Commission
                    </button>
                    <button type="button" id="resetFilters"
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        <i class="fas fa-undo mr-2"></i> Reset Filters
                    </button>
                    {% if has_filters %}
                    <a class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-green-600 text-white hover:bg-green-700 h-10 px-4 py-2"
                        href="{% url 'export_commission_csv' %}?start_date={{ start_date }}&end_date={{ end_date }}&commission_percent={{ commission_percent }}"
                        target="_blank">
                        <i class="fas fa-file-csv mr-2"></i> Export All (CSV)
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- CSR Cards (Always Visible) -->
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% if csrs %}
        {% for csr in csrs %}
        <div
            class="rounded-xl border bg-card text-card-foreground shadow-sm hover:translate-y-[-2px] hover:shadow-md transition-all">
            <div class="p-6 flex flex-col items-center text-center">
                <div
                    class="h-20 w-20 rounded-full bg-primary flex items-center justify-center text-primary-foreground text-2xl font-bold mb-4">
                    {% if csr.user.first_name and csr.user.last_name %}
                    {{ csr.user.first_name|first|upper }}{{ csr.user.last_name|first|upper }}
                    {% else %}
                    {{ csr.get_full_name|first|upper }}
                    {% endif %}
                </div>
                <div class="text-xl font-semibold mb-1">{{ csr.get_full_name }}</div>
                <div class="text-sm text-muted-foreground mb-4">
                    {% if csr.lead_role %}
                    <span
                        class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80">Lead
                        Role</span>
                    {% else %}
                    <span
                        class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80">CSR</span>
                    {% endif %}
                </div>
                <div class="grid grid-cols-2 gap-4 w-full mt-2">
                    <div class="flex flex-col">
                        <span class="text-2xl font-bold">{{ csr.students.count|default:0 }}</span>
                        <span class="text-xs text-muted-foreground uppercase tracking-wider">Total Students</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-bold">{{ csr.completed_students_count|default:0 }}</span>
                        <span class="text-xs text-muted-foreground uppercase tracking-wider">Completed</span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-span-full text-center p-8 text-muted-foreground">
            <h4 class="text-lg font-semibold mb-2">No CSR Profiles Found</h4>
            <p>There are no CSR profiles in the system. Please add some CSR profiles first.</p>
        </div>
        {% endif %}
    </div>

    <!-- Commission Summary (Only visible when filters applied) -->
    {% if has_filters %}
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="flex flex-col space-y-1.5 p-6 border-b border-border">
            <h3 class="font-semibold leading-none tracking-tight">Commission Summary</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                <div class="flex flex-col">
                    <span class="text-3xl font-bold text-primary">Rs. {{
                        total_commission|default:0|floatformat:0|intcomma }}</span>
                    <span class="text-sm text-muted-foreground">Total Commission</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-3xl font-bold">Rs. {{ total_payment_in_range|default:0|floatformat:0|intcomma
                        }}</span>
                    <span class="text-sm text-muted-foreground">Total Payment in Range</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-3xl font-bold">{{ total_admissions|default:0 }}</span>
                    <span class="text-sm text-muted-foreground">Total Admissions</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-3xl font-bold">{{ commission_percent|default:1 }}%</span>
                    <span class="text-sm text-muted-foreground">Commission Rate</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced CSR Cards with Commission Details -->
    <div class="grid gap-6">
        {% if commission_data %}
        {% for item in commission_data %}
        <div
            class="rounded-xl border bg-card text-card-foreground shadow-sm hover:translate-y-[-2px] hover:shadow-md transition-all">
            <div class="p-6">
                <!-- Header Section -->
                <div
                    class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6 pb-6 border-b border-border">
                    <div class="flex items-center gap-4">
                        <div
                            class="h-16 w-16 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-2xl font-bold shadow-sm">
                            {{ item.csr.get_full_name|first|upper }}
                        </div>
                        <div class="flex flex-col gap-1">
                            <div class="text-xl font-bold text-card-foreground">{{
                                item.csr.get_full_name|default:"Unknown CSR" }}</div>
                            <div>
                                {% if item.csr.lead_role %}
                                <span
                                    class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80 uppercase tracking-wide">Lead
                                    Role</span>
                                {% else %}
                                <span
                                    class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80 uppercase tracking-wide">CSR</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full lg:w-auto">
                        <div class="flex flex-col items-center bg-muted/50 p-3 rounded-lg border border-border">
                            <span
                                class="text-[0.7rem] font-semibold text-muted-foreground uppercase tracking-wide mb-1">Payment
                                Range</span>
                            <span class="text-sm font-bold">Rs. {{
                                item.total_payment_in_range|default:0|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="flex flex-col items-center bg-muted/50 p-3 rounded-lg border border-border">
                            <span
                                class="text-[0.7rem] font-semibold text-muted-foreground uppercase tracking-wide mb-1">Comm
                                ({{ commission_percent }}%)</span>
                            <span class="text-lg font-bold text-green-600 dark:text-green-500">Rs. {{
                                item.commission|default:0|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="flex flex-col items-center bg-muted/50 p-3 rounded-lg border border-border">
                            <span
                                class="text-[0.7rem] font-semibold text-muted-foreground uppercase tracking-wide mb-1">Admissions</span>
                            <span class="text-lg font-bold">{{ item.admissions|default:0 }}</span>
                        </div>
                        <div
                            class="flex flex-col items-center bg-muted/50 p-3 rounded-lg border border-border justify-center">
                            <span
                                class="text-[0.7rem] font-semibold text-muted-foreground uppercase tracking-wide mb-1">Export</span>
                            <a class="inline-flex h-8 items-center justify-center rounded-md border border-input bg-background px-3 text-xs font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 text-green-600 border-green-200 hover:bg-green-50 dark:border-green-800 dark:hover:bg-green-900/20"
                                href="{% url 'export_commission_csv' %}?csr_id={{ item.csr.id }}&start_date={{ start_date }}&end_date={{ end_date }}&commission_percent={{ commission_percent }}"
                                target="_blank">
                                <i class="fas fa-file-csv mr-1"></i> CSV
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Students Section -->
                <div class="space-y-4">
                    <h4 class="text-base font-semibold border-b border-border pb-2">Students</h4>
                    <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                        {% for student in item.students %}
                        <div
                            class="rounded-lg border border-border bg-muted/30 p-4 transition-all hover:bg-muted/50 hover:shadow-sm">
                            <div class="flex items-center gap-3 mb-3">
                                <div
                                    class="h-8 w-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold">
                                    {{ student.name|first|upper }}
                                </div>
                                <div class="font-semibold text-sm truncate">{{ student.name|default:"Unknown Student" }}
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-muted-foreground font-medium text-xs">Price:</span>
                                    <span class="font-semibold">Rs. {{
                                        student.discounted_price|default:0|floatformat:0|intcomma }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-muted-foreground font-medium text-xs">Commission:</span>
                                    <span class="font-bold text-green-600 dark:text-green-500">Rs. {{
                                        student.commission_amount|default:0|floatformat:0|intcomma }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-span-full p-8 text-center text-muted-foreground">
            <p class="mb-2">No commission data found for the selected date range.</p>
            <p class="text-sm">Make sure to select both start and end dates to calculate commissions.</p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Instructions when no filters applied -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="p-6">
            <div class="text-center py-8 space-y-4 max-w-2xl mx-auto">
                <h4 class="text-xl font-semibold">How to Use Commission Report</h4>
                <div class="text-left space-y-2 text-muted-foreground">
                    <p class="flex items-start gap-2"><span class="font-bold text-primary">1.</span> Select a start date
                        and end date to filter the commission period</p>
                    <p class="flex items-start gap-2"><span class="font-bold text-primary">2.</span> Adjust the
                        commission percentage if needed (default: 10%)</p>
                    <p class="flex items-start gap-2"><span class="font-bold text-primary">3.</span> Click "Calculate
                        Commission" to view detailed commission data</p>
                    <p class="flex items-start gap-2"><span class="font-bold text-primary">4.</span> Commissions are
                        calculated only for students with completed payments (balance = 0)</p>
                    <p class="flex items-start gap-2"><span class="font-bold text-primary">5.</span> Commission is
                        calculated as a percentage of the discounted price</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize date pickers
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true,
            maxDate: "today"
        });

        // Reset filters button
        document.getElementById('resetFilters').addEventListener('click', function () {
            window.location.href = '{% url "commission_report" %}';
        });

        // Form validation
        document.getElementById('filterForm').addEventListener('submit', function (e) {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            if (!startDate || !endDate) {
                e.preventDefault();
                alert('Please select both start and end dates.');
                return false;
            }

            if (startDate > endDate) {
                e.preventDefault();
                alert('Start date cannot be after end date.');
                return false;
            }
        });
    });
</script>
{% endblock %}