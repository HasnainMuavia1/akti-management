{% extends 'invoice/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}CSR Dashboard{% endblock %}
{% block page_title %}CSR Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    {# Reuse the same stats grid as admin dashboard #}
    {% include 'invoice/partials/_dashboard_stats.html' %}

    {% if csr.lead_role or request.user.is_superuser %}
    <!-- Batch Stats Row (Lead CSR Only) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6">
        <!-- Batch-wise Student Count Chart -->
        <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-row items-center justify-between space-y-0 p-6 pb-2">
                <h3 class="font-semibold leading-none tracking-tight">Batch-wise Student Count</h3>
                <div class="relative">
                    <!-- Dropdown equivalent if needed, or just a link -->
                    <a href="{% url 'report_students_csr' %}"
                        class="text-sm text-muted-foreground hover:text-foreground">
                        <i class="fas fa-external-link-alt"></i> Details
                    </a>
                </div>
            </div>
            <div class="p-6 pt-0">
                <div class="chart-container relative h-72 w-full">
                    <canvas id="batchStudentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Batch-wise Revenue Chart -->
        <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-row items-center justify-between space-y-0 p-6 pb-2">
                <h3 class="font-semibold leading-none tracking-tight">Batch-wise Revenue</h3>
                <div class="relative">
                    <a href="{% url 'report_revenue_csr' %}"
                        class="text-sm text-muted-foreground hover:text-foreground">
                        <i class="fas fa-external-link-alt"></i> Details
                    </a>
                </div>
            </div>
            <div class="p-6 pt-0">
                <div class="chart-container relative h-72 w-full">
                    <canvas id="batchRevenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="flex flex-col space-y-1.5 p-6 pb-4">
            <h3 class="font-semibold leading-none tracking-tight">Quick Actions</h3>
        </div>
        <div class="p-6 pt-0">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                <a href="{% url 'csr_batch_management' %}"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-4 text-sm font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    <i class="fas fa-layer-group mr-2 text-primary"></i> Manage Batches
                </a>
                <a href="{% url 'student_management' %}"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-4 text-sm font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    <i class="fas fa-user-graduate mr-2 text-primary"></i> Manage Students
                </a>
                <a href="#"
                    class="inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-4 text-sm font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    <i class="fas fa-file-invoice mr-2 text-primary"></i> Generate Invoice
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Students -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="flex flex-row items-center justify-between space-y-0 p-6">
            <h3 class="font-semibold leading-none tracking-tight">Recent Students</h3>
            <a href="{% url 'student_management' %}" class="text-sm font-medium text-primary hover:underline">View
                All</a>
        </div>
        <div class="p-0">
            <div class="w-full overflow-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-muted/50 text-muted-foreground font-medium">
                        <tr>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Batch</th>
                            <th class="px-4 py-3 hidden md:table-cell">Courses</th>
                            <th class="px-4 py-3">Total Fees</th>
                            <th class="px-4 py-3">Due Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border">
                        {% for student in students|slice:":5" %}
                        <tr class="hover:bg-muted/50 transition-colors">
                            <td class="px-4 py-3 font-medium">{{ student.name }}</td>
                            <td class="px-4 py-3">{{ student.batch.batch_number }}</td>
                            <td class="px-4 py-3 hidden md:table-cell">
                                {% for course in student.courses.all %}
                                {% if not forloop.first %}, {% endif %}{{ course.name }}
                                {% endfor %}
                            </td>
                            <td class="px-4 py-3">PKR {{ student.total_fees }}</td>
                            <td class="px-4 py-3">{{ student.due_date|date:"d M, Y"|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-muted-foreground">No students registered
                                yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set chart height
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            // Note: with Tailwind's h-72, the height is already set by CSS class, 
            // but we can ensure it here just in case specific chart.js needs helper
        });

        // Check if Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded!');
            return;
        }

        console.log('Fetching batch stats data...');

        // Fetch batch stats data
        fetch('{% url "get_batch_stats" %}')
            .then(response => {
                console.log('Response received:', response);
                return response.json();
            })
            .then(data => {
                console.log('Batch stats data:', data);

                // Check if data has batches
                if (!data.batches || data.batches.length === 0) {
                    console.warn('No batch data received');
                    return;
                }

                // Process batch data for charts
                const batchLabels = data.batches.map(batch => {
                    // Check if batch_number already contains 'Batch' to avoid duplication
                    const batchNum = String(batch.batch_number);
                    return batchNum.includes('Batch') ? batchNum : `Batch #${batchNum}`;
                });
                const studentCounts = data.batches.map(batch => batch.student_count);
                const totalRevenue = data.batches.map(batch => batch.total_revenue);
                const receivedPayment = data.batches.map(batch => batch.received_payment);
                const pendingPayment = data.batches.map(batch => batch.pending_payment);

                console.log('Processed data:', {
                    labels: batchLabels,
                    studentCounts: studentCounts,
                    totalRevenue: totalRevenue,
                    receivedPayment: receivedPayment,
                    pendingPayment: pendingPayment
                });

                // Check canvas elements
                const studentChartCanvas = document.getElementById('batchStudentChart');
                const revenueChartCanvas = document.getElementById('batchRevenueChart');

                console.log('Canvas elements found:', {
                    studentChart: !!studentChartCanvas,
                    revenueChart: !!revenueChartCanvas
                });

                // Render Batch Student Chart (for lead CSRs)
                renderBatchStudentChart(batchLabels, studentCounts);

                // Render Batch Revenue Chart (for lead CSRs)
                renderBatchRevenueChart(batchLabels, totalRevenue, receivedPayment, pendingPayment);

                // Render My Batch Distribution Chart (for regular CSRs - if canvas exists)
                if (document.getElementById('myBatchDistributionChart')) {
                    renderMyBatchDistributionChart(batchLabels, studentCounts);
                }
            })
            .catch(error => {
                console.error('Error fetching batch stats:', error);
                console.error('Error details:', error.message, error.stack);
            });

        // Function to render batch student chart
        function renderBatchStudentChart(labels, data) {
            console.log('renderBatchStudentChart called with:', { labels, data });
            const ctx = document.getElementById('batchStudentChart');
            if (!ctx) {
                console.error('batchStudentChart canvas not found!');
                return;
            }

            console.log('Creating batch student chart...');
            const chartCtx = ctx.getContext('2d');
            try {
                new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Student Count',
                            data: data,
                            backgroundColor: '#4e73df',
                            borderColor: '#4e73df',
                            borderWidth: 1,
                            borderRadius: 4,
                            maxBarThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Students per Batch',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20
                                },
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating batch student chart:', error);
            }
        }

        // Function to render batch revenue chart for lead CSRs
        function renderBatchRevenueChart(labels, totalRevenue, receivedPayment, pendingPayment) {
            console.log('renderBatchRevenueChart called with:', { labels, totalRevenue, receivedPayment, pendingPayment });
            const ctx = document.getElementById('batchRevenueChart');
            if (!ctx) {
                console.error('batchRevenueChart canvas not found!');
                return;
            }

            console.log('Creating batch revenue chart...');
            const chartCtx = ctx.getContext('2d');
            try {
                new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Revenue',
                                data: totalRevenue,
                                backgroundColor: '#4e73df',
                                borderColor: '#4e73df',
                                borderWidth: 1,
                                borderRadius: 4,
                                maxBarThickness: 30
                            },
                            {
                                label: 'Received Payment',
                                data: receivedPayment,
                                backgroundColor: '#1cc88a',
                                borderColor: '#1cc88a',
                                borderWidth: 1,
                                borderRadius: 4,
                                maxBarThickness: 30
                            },
                            {
                                label: 'Pending Payment',
                                data: pendingPayment,
                                backgroundColor: '#f6c23e',
                                borderColor: '#f6c23e',
                                borderWidth: 1,
                                borderRadius: 4,
                                maxBarThickness: 30
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 15,
                                    font: {
                                        size: 11,
                                        weight: 'bold'
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Revenue per Batch',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20
                                },
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return 'Rs. ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating batch revenue chart:', error);
            }
        }

        // Function to render my batch distribution chart for regular CSRs
        function renderMyBatchDistributionChart(labels, data) {
            const ctx = document.getElementById('myBatchDistributionChart');
            if (!ctx) return;

            const chartCtx = ctx.getContext('2d');
            new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FFD166',
                            '#06D6A0',
                            '#118AB2',
                            '#073B4C',
                            '#EF476F'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '60%'
                }
            });
        }
    });
</script>
{% endblock %}