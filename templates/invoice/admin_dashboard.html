{% extends 'invoice/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Admin Dashboard{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
{# Data for charts - using json_script to avoid formatter issues #}
{% if monthly_revenue %}
{{ monthly_revenue|json_script:"revenue-data" }}
{% else %}
{{ "[]"|json_script:"revenue-data" }}
{% endif %}

{% if monthly_labels %}
{{ monthly_labels|json_script:"revenue-labels" }}
{% else %}
{{ "[]"|json_script:"revenue-labels" }}
{% endif %}

{% if courses_data %}
{{ courses_data|json_script:"course-data" }}
{% else %}
{{ '{"labels":[], "data":[]}'|json_script:"course-data" }}
{% endif %}

{% if csr_performance_data %}
{{ csr_performance_data|json_script:"csr-data" }}
{% else %}
{{ '{"labels":[], "data":[]}'|json_script:"csr-data" }}
{% endif %}

<!-- Stats Row - 4 Columns on XL screens, 2 on small/mobile -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-4">
    <!-- Current Students -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-indigo-100 uppercase tracking-wide">Current Students</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">{{ current_students }}</h3>
                <p class="text-[0.75rem] text-indigo-100/80">Students in active batches</p>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-user-graduate text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-indigo-800/20">
            <i class="fas fa-user-graduate text-8xl"></i>
        </div>
    </div>

    <!-- Total Students -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-emerald-100 uppercase tracking-wide">Total Students</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">{{ total_students }}</h3>
                <p class="text-[0.75rem] text-emerald-100/80">All students (active + inactive)</p>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-users text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-emerald-800/20">
            <i class="fas fa-users text-8xl"></i>
        </div>
    </div>

    <!-- Total Revenue -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-blue-100 uppercase tracking-wide">Total Revenue</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">
                    <span>Rs. </span>
                    <span>{{ total_revenue|floatformat:0|intcomma }}</span>
                </h3>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-dollar-sign text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-blue-800/20">
            <i class="fas fa-dollar-sign text-8xl"></i>
        </div>
    </div>

    <!-- Payment Received -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-cyan-500 to-cyan-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-cyan-100 uppercase tracking-wide">Payment Received</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">
                    <span>Rs. </span>
                    <span>{{ payment_received|floatformat:0|intcomma }}</span>
                </h3>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-check-circle text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-cyan-800/20">
            <i class="fas fa-check-circle text-8xl"></i>
        </div>
    </div>

    <!-- Pending Payments -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-amber-100 uppercase tracking-wide">Pending Payments</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">
                    <span>Rs. </span>
                    <span>{{ pending_payments|floatformat:0|intcomma }}</span>
                </h3>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-clock text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-amber-800/20">
            <i class="fas fa-clock text-8xl"></i>
        </div>
    </div>

    <!-- Total CSRs -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-rose-500 to-rose-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-rose-100 uppercase tracking-wide">Total CSRs</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">{{ total_csrs }}</h3>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-user-tie text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-rose-800/20">
            <i class="fas fa-user-tie text-8xl"></i>
        </div>
    </div>

    <!-- Batches -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-violet-500 to-violet-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-violet-100 uppercase tracking-wide">Batches</p>
                <div class="flex items-baseline gap-1">
                    <h3 class="text-2xl font-semibold text-white leading-tight">{{ active_batches }}</h3>
                    <span class="text-sm text-violet-100/80">/ {{ total_batches }}</span>
                </div>
                <a href="{% url 'admin_batch_management' %}"
                    class="inline-flex items-center gap-1 text-[0.7rem] text-violet-100 hover:text-white hover:underline transition-colors">
                    <i class="fas fa-cog text-[0.65rem]"></i> Manage
                </a>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-layer-group text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-violet-800/20">
            <i class="fas fa-layer-group text-8xl"></i>
        </div>
    </div>

    <!-- Total Courses -->
    <div
        class="relative overflow-hidden rounded-xl bg-gradient-to-br from-sky-500 to-sky-600 p-4 shadow-lg transition-transform hover:-translate-y-1">
        <div class="relative z-10 flex items-center justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[0.7rem] font-medium text-sky-100 uppercase tracking-wide">Total Courses</p>
                <h3 class="text-2xl font-semibold text-white leading-tight">{{ total_courses }}</h3>
                <a href="{% url 'course_management' %}"
                    class="inline-flex items-center gap-1 text-[0.7rem] text-sky-100 hover:text-white hover:underline transition-colors">
                    <i class="fas fa-list text-[0.65rem]"></i> View All
                </a>
            </div>
            <div class="flex h-11 w-11 items-center justify-center rounded-full bg-white/15 text-white backdrop-blur-sm">
                <i class="fas fa-book text-lg"></i>
            </div>
        </div>
        <div class="absolute -right-4 -bottom-4 text-sky-800/20">
            <i class="fas fa-book text-8xl"></i>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Monthly Revenue Chart -->
    <div class="lg:col-span-2 bg-card rounded-xl border border-border shadow-sm">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h5 class="font-semibold text-foreground text-lg">Monthly Revenue</h5>
            <div class="dropdown relative">
                <button
                    class="px-4 py-2 rounded-lg border border-border text-sm font-medium hover:bg-accent transition-colors flex items-center gap-2 whitespace-nowrap"
                    data-dropdown-trigger>
                    This Year <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div class="dropdown-menu hidden absolute right-0 mt-2 w-56 bg-card rounded-lg border border-border shadow-lg z-50 p-1"
                    data-dropdown-content>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">This
                        Year</a>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">Last
                        Year</a>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">Last
                        6
                        Months</a>
                </div>
            </div>
        </div>
        <div class="p-4">
            <div class="h-[250px]">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Course Distribution Chart -->
    <div class="bg-card rounded-xl border border-border shadow-sm">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h5 class="font-semibold text-foreground text-lg">Course Distribution</h5>
            <div class="dropdown relative">
                <button
                    class="px-4 py-2 rounded-lg border border-border text-sm font-medium hover:bg-accent transition-colors flex items-center gap-2 whitespace-nowrap"
                    data-dropdown-trigger>
                    This Month <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div class="dropdown-menu hidden absolute right-0 mt-2 w-56 bg-card rounded-lg border border-border shadow-lg z-50 p-1"
                    data-dropdown-content>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">This
                        Month</a>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">Last
                        Month</a>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">Last
                        3
                        Months</a>
                </div>
            </div>
        </div>
        <div class="p-4">
            <div class="h-[250px] flex items-center justify-center">
                <canvas id="courseChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Batch Stats Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Batch-wise Student Count Chart -->
    <div class="bg-card rounded-xl border border-border shadow-sm">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h5 class="font-semibold text-foreground text-lg">Batch-wise Student Count</h5>
            <a href="{% url 'report_students' %}"
                class="px-4 py-2 rounded-lg border border-border text-sm font-medium hover:bg-accent transition-colors flex items-center gap-2">
                <i class="fas fa-external-link-alt text-xs"></i> Details
            </a>
        </div>
        <div class="p-4">
            <div class="h-[250px]">
                <canvas id="batchStudentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Batch-wise Revenue Chart -->
    <div class="bg-card rounded-xl border border-border shadow-sm">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h5 class="font-semibold text-foreground text-lg">Batch-wise Revenue</h5>
            <a href="{% url 'report_revenue' %}"
                class="px-4 py-2 rounded-lg border border-border text-sm font-medium hover:bg-accent transition-colors flex items-center gap-2">
                <i class="fas fa-external-link-alt text-xs"></i> Details
            </a>
        </div>
        <div class="p-4">
            <div class="h-[250px]">
                <canvas id="batchRevenueChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Activity & Performance Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Recent Activity -->
    <div class="lg:col-span-2 bg-card rounded-xl border border-border shadow-sm">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h5 class="font-semibold text-foreground text-lg">Recent Activity</h5>
            <a href="#"
                class="px-4 py-2 rounded-lg border border-border text-sm font-medium hover:bg-accent transition-colors">View
                All</a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-muted/50">
                    <tr>
                        <th class="text-left p-4 font-medium text-muted-foreground uppercase text-xs tracking-wider">CSR
                        </th>
                        <th class="text-left p-4 font-medium text-muted-foreground uppercase text-xs tracking-wider">
                            Action</th>
                        <th class="text-left p-4 font-medium text-muted-foreground uppercase text-xs tracking-wider">
                            Date</th>
                        <th class="text-left p-4 font-medium text-muted-foreground uppercase text-xs tracking-wider">
                            Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border">
                    {% for student in recent_students %}
                    <tr class="hover:bg-muted/50 transition-colors">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">
                                    <span>
                                        {{ student.get_creator_name|default:"U"|slice:":1"|upper }}
                                    </span>
                                </div>
                                <span class="text-foreground font-medium">
                                    {{ student.get_creator_name|default:"Unknown" }}
                                </span>
                            </div>
                        </td>
                        <td class="p-4 text-foreground">
                            <span class="opacity-80">Added new student</span>
                            <span class="font-medium text-primary">{{ student.name }}</span>
                        </td>
                        <td class="p-4 text-muted-foreground">{{ student.created_at|date:"M d, Y" }}</td>
                        <td class="p-4">
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if student.payment_status == 'paid' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400{% elif student.payment_status == 'partial' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400{% else %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400{% endif %}">
                                {{ student.payment_status|title }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted-foreground py-12">
                            <div class="flex flex-col items-center gap-2">
                                <i class="fas fa-inbox text-4xl opacity-20"></i>
                                <p>No recent student enrollments</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- CSR Performance -->
    <div class="bg-card rounded-xl border border-border shadow-sm">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h5 class="font-semibold text-foreground text-lg">CSR Performance</h5>
            <div class="dropdown relative">
                <button
                    class="px-4 py-2 rounded-lg border border-border text-sm font-medium hover:bg-accent transition-colors flex items-center gap-2 whitespace-nowrap"
                    data-dropdown-trigger>
                    This Month <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div class="dropdown-menu hidden absolute right-0 mt-2 w-56 bg-card rounded-lg border border-border shadow-lg z-50 p-1"
                    data-dropdown-content>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">This
                        Month</a>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">Last
                        Month</a>
                    <a href="#"
                        class="block px-4 py-2 text-sm rounded-md hover:bg-accent dropdown-item transition-colors">Last
                        3
                        Months</a>
                </div>
            </div>
        </div>
        <div class="p-4">
            <div class="h-[250px]">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function getJsonData(id) {
            try {
                var elem = document.getElementById(id);
                if (!elem) {
                    console.error('Element not found:', id);
                    return null;
                }
                var data = JSON.parse(elem.textContent);
                console.log('Loaded data for ' + id + ':', data);
                return data;
            } catch (e) {
                console.error('Failed to parse JSON for ' + id + ':', e);
                return null;
            }
        }

        var isDark = document.documentElement.classList.contains('dark');
        var gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
        var textColor = isDark ? '#9ca3af' : '#6b7280';

        function createOptions(custom) {
            return Object.assign({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: textColor, font: { size: 11 } } },
                    tooltip: {
                        backgroundColor: isDark ? '#1f2937' : '#ffffff',
                        titleColor: isDark ? '#f3f4f6' : '#111827',
                        bodyColor: isDark ? '#d1d5db' : '#4b5563',
                        borderColor: isDark ? '#374151' : '#e5e7eb',
                        borderWidth: 1,
                        titleFont: { size: 12 },
                        bodyFont: { size: 11 }
                    }
                }
            }, custom || {});
        }

        var revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx) {
            var revenueData = getJsonData('revenue-data');
            var revenueLabels = getJsonData('revenue-labels');
            if (revenueData && revenueLabels) {
                // Ensure data is numeric
                revenueData = revenueData.map(Number);

                var ctx = revenueCtx.getContext('2d');
                var gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(79, 70, 229, 0.4)');
                gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#4f46e5',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#4f46e5',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: createOptions({
                        scales: {
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor, callback: function (v) { return 'Rs. ' + v.toLocaleString(); } } },
                            x: { grid: { display: false }, ticks: { color: textColor } }
                        }
                    })
                });
            }
        }

        var courseCtx = document.getElementById('courseChart');
        if (courseCtx) {
            var courseData = getJsonData('course-data');
            if (courseData && courseData.labels && courseData.labels.length > 0) {
                // Ensure data is numeric
                if (courseData.data) {
                    courseData.data = courseData.data.map(Number);
                }

                var colors = [];
                for (var i = 0; i < courseData.labels.length; i++) {
                    var hue = Math.floor(i * (360 / courseData.labels.length));
                    colors.push('hsl(' + hue + ', 70%, 60%)');
                }
                new Chart(courseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: courseData.labels,
                        datasets: [{
                            data: courseData.data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: isDark ? '#1f2937' : '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 20 } } },
                        cutout: '75%'
                    }
                });
            }
        }

        var csrCtx = document.getElementById('performanceChart');
        if (csrCtx) {
            var csrData = getJsonData('csr-data');
            if (csrData && csrData.labels && csrData.labels.length > 0) {
                // Ensure data is numeric
                if (csrData.data) {
                    csrData.data = csrData.data.map(Number);
                }

                new Chart(csrCtx, {
                    type: 'bar',
                    data: {
                        labels: csrData.labels,
                        datasets: [{
                            label: 'Students',
                            data: csrData.data,
                            backgroundColor: '#10b981',
                            borderRadius: 6,
                            maxBarThickness: 40
                        }]
                    },
                    options: createOptions({
                        scales: {
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                            x: { grid: { display: false }, ticks: { color: textColor } }
                        }
                    })
                });
            }
        }

        fetch('/api/batch-stats/')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                console.log('Batch stats:', data);

                var labels = [];
                var studentCounts = [];
                var totalRevenue = [];
                var receivedRevenue = [];
                var pendingRevenue = [];

                if (data.batches) {
                    data.batches.forEach(function (b) {
                        labels.push(b.batch_number);
                        studentCounts.push(b.student_count);
                        totalRevenue.push(b.total_revenue);
                        receivedRevenue.push(b.received_payment);
                        pendingRevenue.push(b.pending_payment);
                    });
                } else if (data.labels) {
                    // Fallback
                    labels = data.labels;
                    studentCounts = data.student_counts;
                    totalRevenue = data.total_revenue || [];
                    receivedRevenue = data.received_payment || [];
                    pendingRevenue = data.pending_payment || [];
                }

                var bsCtx = document.getElementById('batchStudentChart');
                if (bsCtx && labels.length > 0) {
                    new Chart(bsCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Students',
                                data: studentCounts,
                                backgroundColor: '#8b5cf6',
                                borderRadius: 6,
                                maxBarThickness: 40
                            }]
                        },
                        options: createOptions({
                            scales: {
                                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                                x: { grid: { display: false }, ticks: { color: textColor } }
                            }
                        })
                    });
                }

                var brCtx = document.getElementById('batchRevenueChart');
                if (brCtx && labels.length > 0) {
                    var datasets = [];
                    // If we have detailed revenue data, show stacked/grouped
                    if (receivedRevenue.length > 0) {
                        datasets.push({ label: 'Received', data: receivedRevenue, backgroundColor: '#10b981', borderRadius: 4 });
                    }
                    if (pendingRevenue.length > 0) {
                        datasets.push({ label: 'Pending', data: pendingRevenue, backgroundColor: '#f59e0b', borderRadius: 4 });
                    }
                    // If we don't have detailed data or just want total, fallback to total
                    if (datasets.length === 0 && totalRevenue.length > 0) {
                        datasets.push({ label: 'Total Revenue', data: totalRevenue, backgroundColor: '#3b82f6', borderRadius: 4 });
                    } else if (totalRevenue.length > 0) {
                        // Optional: Add total as a line or just rely on components
                        // For now, let's show components if available
                    }

                    new Chart(brCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: createOptions({
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: gridColor },
                                    ticks: {
                                        color: textColor,
                                        callback: function (value) { return 'Rs. ' + value.toLocaleString(); }
                                    },
                                    stacked: true
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: textColor },
                                    stacked: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            var label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed.y !== null) {
                                                label += 'Rs. ' + context.parsed.y.toLocaleString();
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        })
                    });
                }
            })
            .catch(function (error) {
                console.error('Error loading batch stats:', error);
            });
    });
</script>
{% endblock %}