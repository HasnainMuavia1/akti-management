{% extends 'invoice/base_csr.html' %}
{% load static %}

{% block title %}Student Management{% endblock %}
{% block page_title %}Student Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Batch Filter Card -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="p-6">
            <h3 class="text-lg font-semibold leading-none tracking-tight mb-4">Batch Management</h3>
            <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-4">
                <div class="w-full sm:w-1/2 space-y-2">
                    <label class="text-sm font-medium leading-none">Current Batch</label>
                    <select id="batchFilter"
                        class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">All Batches</option>
                        {% for batch in batches %}
                        <option value="{{ batch.id }}">{{ batch.batch_number }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button onclick="openModal('addStudentModal')"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full sm:w-auto">
                    <i class="fas fa-plus mr-2"></i> Add Student
                </button>
            </div>
        </div>
    </div>

    <!-- Student List Card -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="p-6 flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-border">
            <h3 class="text-lg font-semibold leading-none tracking-tight">Student Management</h3>
            <div class="relative w-full sm:w-72">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-xs"></i>
                <input type="text" id="studentSearch"
                    class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 pl-9 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    placeholder="Search students...">
            </div>
        </div>
        <div class="p-0 overflow-x-auto">
            <table class="w-full text-sm text-left" id="studentsTable">
                <thead class="bg-muted/50 text-muted-foreground font-medium">
                    <tr>
                        <th class="px-4 py-3 min-w-[150px]">Full Name</th>
                        <th class="px-4 py-3">Batch</th>
                        <th class="px-4 py-3 min-w-[200px]">Courses</th>
                        <th class="px-4 py-3">Advance</th>
                        <th class="px-4 py-3">Balance</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3">Registration</th>
                        <th class="px-4 py-3">Due Date</th>
                        <th class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border">
                    {% for student in students %}
                    <tr class="hover:bg-muted/50 transition-colors" data-batch-id="{{ student.batch.id }}">
                        <td class="px-4 py-3 font-medium text-foreground">{{ student.name }}</td>
                        <td class="px-4 py-3">{{ student.batch.batch_number }}</td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                {% for course in student.courses.all %}
                                <span
                                    class="inline-flex items-center rounded-sm border px-2 py-0.5 text-xs font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 text-foreground">
                                    {{ course.name }}
                                </span>
                                {% empty %}-{% endfor %}
                            </div>
                        </td>
                        <td class="px-4 py-3">PKR {{ student.advance_payment }}</td>
                        <td class="px-4 py-3 balance-cell font-medium">PKR {{ student.balance }}</td>
                        <td class="px-4 py-3 text-center">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="paymentStatus{{ student.id }}" class="sr-only peer" {% if
                                    student.payment_status=='paid' %}checked{% endif %}
                                    onchange="updatePaymentStatus('{{ student.id }}', this.checked)">
                                <div
                                    class="w-9 h-5 bg-input peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-ring rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                </div>
                                <span class="ml-2 text-xs font-medium text-muted-foreground"
                                    id="paymentLabel{{ student.id }}">
                                    {% if student.payment_status == 'paid' %}Paid{% else %}Pending{% endif %}
                                </span>
                            </label>
                        </td>
                        <td class="px-4 py-3 text-muted-foreground">{{ student.created_at|date:"d M Y" }}</td>
                        <td class="px-4 py-3 text-muted-foreground">{% if student.due_date %}{{ student.due_date|date:"d
                            M Y" }}{% else %}-{% endif %}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex flex-col gap-2 items-end">
                                <div class="flex gap-2">
                                    <button
                                        class="inline-flex items-center justify-center rounded-md text-xs font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 px-2"
                                        onclick="window.location.href='/csr/students/{{ student.id }}/invoice/?type=invoice'">
                                        <i class="fas fa-file-invoice mr-1"></i> Invoice
                                    </button>
                                    <button
                                        class="inline-flex items-center justify-center rounded-md text-xs font-medium border border-input bg-background hover:bg-orange-50 hover:text-orange-600 dark:hover:bg-orange-900/20 h-7 px-2"
                                        onclick="window.location.href='/csr/students/{{ student.id }}/invoice/?type=pending'">
                                        <i class="fas fa-clock mr-1"></i> Pending
                                    </button>
                                </div>
                                <button
                                    class="inline-flex items-center justify-center rounded-md text-xs font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-7 px-2 w-full"
                                    onclick="editStudent('{{ student.id }}')">
                                    <i class="fas fa-edit mr-1"></i> Edit Details
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-muted-foreground">
                            <div class="flex flex-col items-center justify-center gap-2">
                                <div class="bg-muted/50 p-3 rounded-full">
                                    <i class="fas fa-user-graduate text-xl opacity-50"></i>
                                </div>
                                <p class="text-sm font-medium">No Students Found</p>
                                <p class="text-xs opacity-70">Add your first student to get started</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_other_pages %}
        <div class="px-4 py-3 border-t border-border flex items-center justify-between text-xs text-muted-foreground">
            <div>
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </div>
            <div class="inline-flex items-center gap-1">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}"
                    class="px-2 py-1 rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground">
                    Previous
                </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                <span
                    class="px-3 py-1 rounded-md bg-primary text-primary-foreground border border-primary font-semibold">{{ num }}</span>
                {% elif num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                <a href="?page={{ num }}"
                    class="px-3 py-1 rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground">
                    {{ num }}
                </a>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}"
                    class="px-2 py-1 rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground">
                    Next
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Student Modal -->
<div id="addStudentModal"
    class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div
        class="bg-background rounded-lg shadow-lg max-w-3xl w-full border border-border overflow-y-auto max-h-[90vh] animate-in fade-in zoom-in-95 duration-200">
        <div class="flex items-center justify-between p-4 border-b border-border">
            <h3 class="text-lg font-semibold">Add New Student</h3>
            <button onclick="closeModal('addStudentModal')" class="text-muted-foreground hover:text-foreground">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="POST" action="{% url 'student_management' %}" id="addStudentForm">
            {% csrf_token %}
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Student Name</label>
                        <input type="text" name="name" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Guardian Name</label>
                        <input type="text" name="guardian_name" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Phone Number</label>
                        <input type="text" name="phone_number" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">CNIC</label>
                        <input type="text" name="cnic" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Batch</label>
                        <select name="batch" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                            <option value="">Select Batch</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}">{{ batch.batch_number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Courses</label>
                        <select id="courses" name="courses" multiple required
                            class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }} (PKR {{ course.price }})</option>
                            {% endfor %}
                        </select>
                        <p class="text-[10px] text-muted-foreground">Hold Ctrl/Cmd to select multiple</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 border-t border-border pt-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Total Fees (PKR)</label>
                        <input type="number" id="total_fees" name="total_fees" readonly
                            class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Discount (%)</label>
                        <input type="number" id="discount" name="discount" value="0" min="0" max="100" step="0.01"
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Discounted Price</label>
                        <input type="number" id="discounted_price" name="discounted_price" readonly
                            class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none block">Schedule</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="schedule" value="weekend" checked
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Weekend</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="schedule" value="weekdays"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Weekdays</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="schedule" value="1_month"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">1 Month</span>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none block">Payment Method</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="payment_method" value="cash" checked
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Cash</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="payment_method" value="online"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Online</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 border-t border-border pt-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Advance Payment</label>
                        <input type="number" id="advance_payment" name="advance_payment" value="0" min="0"
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Balance</label>
                        <input type="number" id="second_installment" name="second_installment" value="0" readonly
                            class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Balance Due Date</label>
                        <input type="date" name="second_installment_due_date"
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2 p-4 border-t border-border bg-muted/20">
                <button type="button" onclick="closeModal('addStudentModal')"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">
                    Cancel
                </button>
                <button type="submit"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
                    Add Student
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Student Modal -->
<div id="editStudentModal"
    class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div
        class="bg-background rounded-lg shadow-lg max-w-3xl w-full border border-border overflow-y-auto max-h-[90vh] animate-in fade-in zoom-in-95 duration-200">
        <div class="flex items-center justify-between p-4 border-b border-border">
            <h3 class="text-lg font-semibold">Edit Student</h3>
            <button onclick="closeModal('editStudentModal')" class="text-muted-foreground hover:text-foreground">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="POST" id="editStudentForm">
            {% csrf_token %}
            <input type="hidden" id="edit_student_id" name="student_id">
            <input type="hidden" id="edit_balance" name="balance" value="0">
            <input type="hidden" id="edit_total_amount" name="total_amount" value="0">
            <input type="hidden" id="edit_payment_status" name="payment_status" value="pending">

            <div class="p-6 space-y-4">
                <!-- Mirrors Add Form Structure using Edit IDs -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Student Name</label>
                        <input type="text" id="edit_name" name="name" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Guardian Name</label>
                        <input type="text" id="edit_guardian_name" name="guardian_name" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Phone Number</label>
                        <input type="text" id="edit_phone_number" name="phone_number" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">CNIC</label>
                        <input type="text" id="edit_cnic" name="cnic" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Batch</label>
                        <select id="edit_batch" name="batch" required
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                            <option value="">Select Batch</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Courses</label>
                        <select id="edit_courses" name="courses" multiple required
                            class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 border-t border-border pt-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Total Fees (PKR)</label>
                        <input type="number" id="edit_total_fees" name="total_fees" readonly
                            class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Discount (%)</label>
                        <input type="number" id="edit_discount" name="discount" step="0.01"
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Discounted Price</label>
                        <input type="number" id="edit_discounted_price" name="discounted_price" readonly
                            class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none block">Schedule</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="schedule" value="weekend" id="editScheduleWeekend"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Weekend</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="schedule" value="weekdays" id="editScheduleWeekdays"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Weekdays</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="schedule" value="1_month" id="editScheduleOneMonth"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">1 Month</span>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none block">Payment Method</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="payment_method" value="cash" id="editPaymentMethodCash"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Cash</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="payment_method" value="online" id="editPaymentMethodOnline"
                                    class="text-primary focus:ring-primary">
                                <span class="text-sm">Online</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-border pt-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Advance Payment</label>
                        <input type="number" id="edit_advance_payment" name="advance_payment"
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Balance</label>
                        <input type="number" id="edit_second_installment" name="second_installment" readonly
                            class="flex h-9 w-full rounded-md border border-input bg-muted px-3 py-1 text-sm shadow-sm">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none">Balance Due Date</label>
                        <input type="date" id="edit_second_installment_due_date" name="second_installment_due_date"
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2 p-4 border-t border-border bg-muted/20">
                <button type="button" onclick="closeModal('editStudentModal')"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">
                    Cancel
                </button>
                <button type="submit"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Modal Logic
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.body.style.overflow = '';
    }

    window.onclick = function (event) {
        if (event.target.classList.contains('fixed')) {
            event.target.classList.add('hidden');
            document.body.style.overflow = '';
        }
    }

    // --- Calculation Logic (reused for both Add and Edit) ---
    function setupCalculations(prefix = '') {
        const coursesSelect = document.getElementById(prefix + 'courses');
        const totalFeesInput = document.getElementById(prefix + 'total_fees');
        const discountInput = document.getElementById(prefix + 'discount');
        const discountedPriceInput = document.getElementById(prefix + 'discounted_price');
        const advancePaymentInput = document.getElementById(prefix + 'advance_payment');
        const secondInstallmentInput = document.getElementById(prefix + 'second_installment');

        function calculateFees() {
            let totalFees = 0;
            if (coursesSelect) {
                Array.from(coursesSelect.selectedOptions).forEach(option => {
                    const priceMatch = option.text.match(/\(PKR\s+(\d+(?:\.\d+)?)\)/);
                    if (priceMatch) totalFees += parseFloat(priceMatch[1]);
                });
                totalFees = Math.round(totalFees);
                if (totalFeesInput) totalFeesInput.value = totalFees;
            }

            const discount = parseFloat(discountInput?.value) || 0;
            const discountAmount = Math.round(totalFees * (discount / 100));
            const discountedPrice = totalFees - discountAmount;
            if (discountedPriceInput) discountedPriceInput.value = Math.round(discountedPrice);

            const advancePayment = parseInt(advancePaymentInput?.value) || 0;
            const pendingPayment = Math.max(0, discountedPrice - advancePayment);
            if (secondInstallmentInput) secondInstallmentInput.value = Math.round(pendingPayment);
        }

        if (coursesSelect) coursesSelect.addEventListener('change', calculateFees);
        if (discountInput) discountInput.addEventListener('input', calculateFees);
        if (advancePaymentInput) advancePaymentInput.addEventListener('input', calculateFees);
    }

    setupCalculations(); // Initialize for Add Form
    setupCalculations('edit_'); // Initialize for Edit Form

    // --- Filtering Logic ---
    const batchFilter = document.getElementById('batchFilter');
    const studentSearch = document.getElementById('studentSearch');

    function filterStudents() {
        const query = studentSearch.value.toLowerCase();
        const batchId = batchFilter.value;
        const rows = document.querySelectorAll('#studentsTable tbody tr');

        rows.forEach(row => {
            if (row.cells.length <= 1) return;
            const name = row.cells[0].textContent.toLowerCase();
            const rowBatchId = row.dataset.batchId;

            const matchQuery = name.includes(query);
            const matchBatch = !batchId || rowBatchId === batchId;

            row.style.display = (matchQuery && matchBatch) ? '' : 'none';
        });
    }

    if (batchFilter) batchFilter.addEventListener('change', filterStudents);
    if (studentSearch) studentSearch.addEventListener('input', filterStudents);

    // --- Update Payment Status ---
    function updatePaymentStatus(studentId, isChecked) {
        const status = isChecked ? 'paid' : 'pending';
        fetch(`/csr/students/${studentId}/update-payment-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ payment_status: status })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`paymentLabel${studentId}`).textContent = isChecked ? 'Paid' : 'Pending';
                    // Reload or update UI balance if needed
                    if (data.balance !== undefined) {
                        // Find the balance cell (5th column, index 4)
                        const row = document.getElementById(`paymentStatus${studentId}`).closest('tr');
                        const balanceCell = row.querySelector('.balance-cell');
                        if (balanceCell) balanceCell.textContent = `PKR ${data.balance}`;
                    }
                } else {
                    alert('Failed to update status');
                    document.getElementById(`paymentStatus${studentId}`).checked = !isChecked;
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error updating status');
                document.getElementById(`paymentStatus${studentId}`).checked = !isChecked;
            });
    }

    // --- Edit Student Logic ---
    function editStudent(studentId) {
        document.body.style.cursor = 'wait';
        fetch(`/csr/students/${studentId}/edit/`)
            .then(res => res.json())
            .then(data => {
                const s = data.student;
                document.getElementById('edit_student_id').value = studentId;
                document.getElementById('edit_name').value = s.name;
                document.getElementById('edit_guardian_name').value = s.guardian_name;
                document.getElementById('edit_phone_number').value = s.phone_number;
                document.getElementById('edit_cnic').value = s.cnic;

                // Batches
                const batchSelect = document.getElementById('edit_batch');
                batchSelect.innerHTML = '<option value="">Select Batch</option>';
                data.batches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = b.batch_number;
                    if (b.id == s.batch) opt.selected = true;
                    batchSelect.appendChild(opt);
                });

                // Courses
                const coursesSelect = document.getElementById('edit_courses');
                coursesSelect.innerHTML = '';
                data.courses.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = `${c.name} (PKR ${c.price})`;
                    if (s.courses.includes(c.id)) opt.selected = true;
                    coursesSelect.appendChild(opt);
                });

                document.getElementById('edit_total_fees').value = s.total_fees;
                document.getElementById('edit_discount').value = s.discount;
                document.getElementById('edit_discounted_price').value = s.discounted_price;
                document.getElementById('edit_advance_payment').value = s.advance_payment;
                document.getElementById('edit_second_installment').value = s.balance || s.second_installment;
                document.getElementById('edit_second_installment_due_date').value = s.second_installment_due_date || '';

                // Radios
                if (s.schedule) {
                    const r = document.querySelector(`input[name="schedule"][value="${s.schedule}"][id^="edit"]`);
                    if (r) r.checked = true;
                }
                if (s.payment_method) {
                    const r = document.querySelector(`input[name="payment_method"][value="${s.payment_method}"][id^="edit"]`);
                    if (r) r.checked = true;
                }

                document.body.style.cursor = 'default';
                openModal('editStudentModal');

                // Trigger calculation to ensure consistency
                const event = new Event('change');
                coursesSelect.dispatchEvent(event);
            })
            .catch(err => {
                document.body.style.cursor = 'default';
                alert('Error loading student details');
                console.error(err);
            });
    }
</script>
{% endblock %}