{% load static %}
<!DOCTYPE html>
<html lang="en" class="{% if request.session.dark_mode %}dark{% endif %}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{% block title %}CSR Dashboard{% endblock %} | InvoiceMaker Pro</title>
    <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}">

    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                        sidebar: {
                            DEFAULT: 'hsl(var(--sidebar))',
                            foreground: 'hsl(var(--sidebar-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    },
                },
            },
        }
    </script>

    <!-- Basecoat CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.11/dist/basecoat.cdn.min.css">

    <!-- Basecoat JS -->
    <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.11/dist/js/all.min.js" defer></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/globals.css' %}">

    {% block extra_css %}{% endblock %}

    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --sidebar: 0 0% 98%;
            --sidebar-foreground: 222.2 84% 4.9%;
            --sidebar-border: 214.3 31.8% 91.4%;
            --radius: 0.5rem;
        }

        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 210 40% 98%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
            --sidebar: 222.2 84% 4.9%;
            --sidebar-foreground: 210 40% 98%;
            --sidebar-border: 217.2 32.6% 17.5%;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        /* Stat Card Gradients */
        .stat-card-primary {
            background: linear-gradient(135deg, hsl(243 75% 59%), hsl(243 75% 50%));
            color: white;
        }

        .stat-card-danger {
            background: linear-gradient(135deg, hsl(0 72% 51%), hsl(0 72% 45%));
            color: white;
        }

        .stat-card-info {
            background: linear-gradient(135deg, hsl(199 89% 48%), hsl(199 89% 42%));
            color: white;
        }

        .stat-card-success {
            background: linear-gradient(135deg, hsl(158 64% 52%), hsl(158 64% 45%));
            color: white;
        }

        .stat-card-warning {
            background: linear-gradient(135deg, hsl(38 92% 50%), hsl(38 92% 44%));
            color: white;
        }

        .stat-card-violet {
            background: linear-gradient(135deg, hsl(262 83% 58%), hsl(262 83% 50%));
            color: white;
        }

        .stat-card-cyan {
            background: linear-gradient(135deg, hsl(188 86% 39%), hsl(188 86% 33%));
            color: white;
        }

        .stat-card-rose {
            background: linear-gradient(135deg, hsl(350 89% 60%), hsl(350 89% 53%));
            color: white;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
    </style>
</head>

<body class="bg-background text-foreground min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed left-0 top-0 h-full w-[280px] bg-sidebar border-r border-border flex flex-col z-50 transition-transform duration-200 lg:translate-x-0 -translate-x-full">
            <!-- Sidebar Header -->
            <div
                class="h-[70px] px-4 flex items-center justify-between lg:justify-center border-b border-border relative">
                <img src="{% static 'images/logo.png' %}" alt="Devinci Dev"
                    class="h-12 w-auto transition-all duration-200">
                <button id="closeSidebar"
                    class="lg:hidden p-2 rounded-md hover:bg-accent text-sidebar-foreground absolute right-4">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto py-3">
                <nav>
                    <!-- Main Section -->
                    <div class="mb-4">
                        <h6 class="px-4 mb-1 text-[0.65rem] font-semibold uppercase tracking-wide text-muted-foreground">Main
                        </h6>
                        <ul class="space-y-0.5">
                            <li>
                                <a href="{% url 'csr_dashboard' %}"
                                    class="flex items-center gap-2.5 px-4 py-2 rounded-md text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if request.resolver_match.url_name == 'csr_dashboard' %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-chart-line w-4 text-xs"></i>
                                    <span class="truncate">Dashboard</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Management Section -->
                    <div class="mb-4">
                        <h6 class="px-4 mb-1 text-[0.65rem] font-semibold uppercase tracking-wide text-muted-foreground">
                            Management</h6>
                        <ul class="space-y-0.5">
                            <li>
                                <a href="{% url 'student_management' %}"
                                    class="flex items-center gap-2.5 px-4 py-2 rounded-md text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if 'student_management' in request.path %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-user-graduate w-4 text-xs"></i>
                                    <span class="truncate">Student Management</span>
                                </a>
                            </li>
                            {% if request.user.is_superuser or request.user.csr_profile.lead_role %}
                            <li>
                                <a href="{% url 'course_management_csr' %}"
                                    class="flex items-center gap-3 px-6 py-2.5 text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if 'course' in request.path %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-book w-5"></i>
                                    <span>Course Management</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>

                    <!-- Reports Section (Lead/Superuser Only) -->
                    {% if request.user.is_superuser or request.user.csr_profile.lead_role %}
                    <div class="mb-4">
                        <h6 class="px-4 mb-1 text-[0.65rem] font-semibold uppercase tracking-wide text-muted-foreground">
                            Reports</h6>
                        <ul class="space-y-0.5">
                            <li>
                                <a href="{% url 'report_students_csr' %}"
                                    class="flex items-center gap-3 px-6 py-2.5 text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if 'reports/students' in request.path %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-file-excel w-5"></i>
                                    <span>Student Details</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'report_revenue_csr' %}"
                                    class="flex items-center gap-3 px-6 py-2.5 text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if 'reports/revenue' in request.path %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-chart-pie w-5"></i>
                                    <span>Revenue by Batch</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Settings Section -->
                    <div class="mb-4">
                        <h6 class="px-4 mb-1 text-[0.65rem] font-semibold uppercase tracking-wide text-muted-foreground">
                            Settings</h6>
                        <ul class="space-y-0.5">
                            <li>
                                <a href="{% url 'invoice_settings' %}"
                                    class="flex items-center gap-3 px-6 py-2.5 text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if request.resolver_match.url_name == 'invoice_settings' %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-file-invoice w-5"></i>
                                    <span>Invoice Settings</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'invoice_settings' %}"
                                    class="flex items-center gap-3 px-6 py-2.5 text-sm text-sidebar-foreground hover:bg-accent transition-colors {% if request.resolver_match.url_name == 'invoice_settings' %}bg-accent border-l-4 border-primary{% endif %}">
                                    <i class="fas fa-cog w-5"></i>
                                    <span>Settings</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-3 border-t border-border">
                <div class="flex items-center gap-2.5 p-2 rounded-lg bg-accent">
                    <div class="w-9 h-9 rounded-full bg-muted flex items-center justify-center overflow-hidden">
                        {% if request.user.csr_profile.invoice_settings.avatar %}
                        <img src="{{ request.user.csr_profile.invoice_settings.avatar.url }}" alt="Avatar"
                            class="h-9 w-9 rounded-full object-cover">
                        {% else %}
                        <i class="fas fa-user-circle text-lg text-muted-foreground"></i>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0 leading-tight">
                        <p class="text-sm font-medium text-foreground truncate">{{ request.user.username }}</p>
                        <p class="text-[0.7rem] text-muted-foreground truncate">
                            {% if request.user.csr_profile.lead_role %}Lead CSR{% else %}CSR{% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex justify-end gap-1 mt-2.5">
                    <button id="darkModeToggle" class="p-2 rounded-md hover:bg-accent text-muted-foreground"
                        title="Toggle Dark Mode">
                        <i class="fas {% if request.session.dark_mode %}fa-sun{% else %}fa-moon{% endif %}"></i>
                    </button>
                    <a href="{% url 'invoice_settings' %}" class="p-2 rounded-md hover:bg-accent text-muted-foreground"
                        title="Settings">
                        <i class="fas fa-cog"></i>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-0 lg:ml-[280px] flex flex-col min-h-screen transition-all duration-200">
            <!-- Top Header -->
            <header
                class="h-[70px] bg-background border-b border-border px-6 flex items-center justify-between sticky top-0 z-40">
                <div class="flex items-center gap-4">
                    <button id="toggleSidebar" class="p-2 rounded-md hover:bg-accent text-foreground lg:hidden">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-xl font-semibold text-foreground">{% block page_title %}Dashboard{% endblock %}</h1>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <div class="relative hidden md:block">
                        <input type="text" placeholder="Search..."
                            class="w-64 px-4 py-2 pr-10 rounded-full border border-border bg-background text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-ring">
                        <button class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- Notifications -->
                    <button class="relative p-2 rounded-md hover:bg-accent text-foreground" title="Notifications">
                        <i class="fas fa-bell"></i>
                        <span
                            class="absolute -top-1 -right-1 w-5 h-5 bg-destructive text-destructive-foreground text-xs rounded-full flex items-center justify-center">3</span>
                    </button>
                    <!-- User Dropdown -->
                    <div class="dropdown">
                        <button class="p-2 rounded-md hover:bg-accent text-foreground" data-dropdown-trigger>
                            {% if request.user.csr_profile.invoice_settings.avatar %}
                            <img src="{{ request.user.csr_profile.invoice_settings.avatar.url }}" alt="Avatar"
                                class="h-7 w-7 rounded-full object-cover border border-border">
                            {% else %}
                            <i class="fas fa-user-circle text-xl"></i>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu hidden" data-dropdown-content>
                            <a href="{% url 'change_password' %}" class="dropdown-item"><i class="fas fa-key mr-2"></i>
                                Change Password</a>
                            <a href="{% url 'logout' %}" class="dropdown-item"><i class="fas fa-sign-out-alt mr-2"></i>
                                Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 p-6 bg-muted">
                <!-- Alert Messages -->
                {% if messages %}
                <div class="mb-4 space-y-2" id="toastContainer">
                    {% for message in messages %}
                    <div
                        class="admin-toast alert-{{ message.tags }} p-4 rounded-lg border flex items-center justify-between
                        {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-300{% endif %}
                        {% if message.tags == 'error' or message.tags == 'danger' %}bg-red-50 border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-300{% endif %}
                        {% if message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-300{% endif %}
                        {% if message.tags == 'info' %}bg-blue-50 border-blue-200 text-blue-800 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300{% endif %}">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.remove()" class="text-current opacity-70 hover:opacity-100">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Main Content -->
                {% block content %}{% endblock %}
            </div>

            <!-- Footer -->
            <footer
                class="h-14 bg-background border-t border-border px-6 flex items-center justify-between text-sm text-muted-foreground">
                <p>&copy; 2025 Devinci Dev</p>
                <p>InvoiceMaker Pro v1.0</p>
            </footer>
        </main>
    </div>

    <!-- Custom JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            const closeBtn = document.getElementById('closeSidebar');
            const darkModeToggle = document.getElementById('darkModeToggle');

            // Sidebar toggle for mobile
            if (toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', function () {
                    sidebar.classList.toggle('-translate-x-full');
                    sidebar.classList.toggle('translate-x-0');
                });
            }

            if (closeBtn && sidebar) {
                closeBtn.addEventListener('click', function () {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                });
            }

            // Dark mode toggle
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', function () {
                    document.documentElement.classList.toggle('dark');
                    const icon = darkModeToggle.querySelector('i');
                    icon.classList.toggle('fa-moon');
                    icon.classList.toggle('fa-sun');

                    // Save preference
                    fetch('/toggle-dark-mode/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                });
            }

            // Dropdown handling
            document.querySelectorAll('[data-dropdown-trigger]').forEach(trigger => {
                trigger.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const menu = this.nextElementSibling;
                    if (menu && menu.hasAttribute('data-dropdown-content')) {
                        menu.classList.toggle('hidden');
                    }
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function () {
                document.querySelectorAll('[data-dropdown-content]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            });

            // CSRF token helper
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Auto-dismiss toast messages after 2 seconds
            const adminToasts = document.querySelectorAll('.admin-toast');
            if (adminToasts.length) {
                setTimeout(() => {
                    adminToasts.forEach(toast => {
                        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                        setTimeout(() => toast.remove(), 300);
                    });
                }, 2000);
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>