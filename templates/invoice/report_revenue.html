{% extends 'invoice/base_admin.html' %}
{% load static %}
{% load humanize %}

{% block title %}Revenue Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Loading Indicator Overlay -->
    <div id="loadingIndicator"
        class="fixed inset-0 z-50 hidden items-center justify-center bg-background/80 backdrop-blur-sm">
        <div class="flex flex-col items-center gap-2">
            <i class="fas fa-circle-notch fa-spin text-4xl text-primary"></i>
            <p class="text-sm font-medium text-muted-foreground">Loading report data...</p>
        </div>
    </div>

    <div class="flex flex-col gap-1">
        <h3 class="text-xl font-semibold tracking-tight">Revenue Report</h3>
        <p class="text-sm text-muted-foreground">Generate revenue reports by batch and course with filtering options</p>
    </div>

    <!-- Filters Card -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="p-6 space-y-6">
            <h2 class="text-lg font-semibold leading-none tracking-tight">Report Filters</h2>
            <form method="get" id="filterForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="space-y-2">
                        <label for="batch"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Batch</label>
                        <select id="batch" name="batch"
                            class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            <option value="">All Batches</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}"
                                {% if selected_batch|stringformat:"s" == batch.id|stringformat:"s" %}selected{% endif %}>
                                {{ batch.batch_number }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="course"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Course</label>
                        <select id="course" name="course"
                            class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            <option value="">All Courses</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}"
                                {% if selected_course|stringformat:"s" == course.id|stringformat:"s" %}selected{% endif %}>
                                {{ course.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="start_date"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Start
                            Date</label>
                        <input type="text" id="start_date" name="start_date" placeholder="From"
                            value="{{ start_date|default:'' }}"
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 datepicker">
                    </div>
                    <div class="space-y-2">
                        <label for="end_date"
                            class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">End
                            Date</label>
                        <input type="text" id="end_date" name="end_date" placeholder="To"
                            value="{{ end_date|default:'' }}"
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 datepicker">
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" id="resetFilters"
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        <i class="fas fa-undo mr-2"></i> Reset Filters
                    </button>
                    <button type="button" id="exportExcel"
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-green-600 text-white hover:bg-green-700 h-10 px-4 py-2">
                        <i class="fas fa-file-excel mr-2"></i> Export to Excel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Revenue Summary Cards -->
    <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Total Revenue</h3>
                <i class="fas fa-coins h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
                <!-- Initial value will be updated via AJAX -->
                <div class="text-2xl font-bold" id="totalRevenue">Rs. 0</div>
            </div>
        </div>
        <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Received Payment</h3>
                <i class="fas fa-check-circle h-4 w-4 text-green-500"></i>
            </div>
            <div class="p-6 pt-0">
                <!-- Initial value will be updated via AJAX -->
                <div class="text-2xl font-bold" id="receivedPayment">Rs. 0</div>
            </div>
        </div>
        <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Pending Payment</h3>
                <i class="fas fa-clock h-4 w-4 text-yellow-500"></i>
            </div>
            <div class="p-6 pt-0">
                <!-- Initial value will be updated via AJAX -->
                <div class="text-2xl font-bold" id="pendingPayment">Rs. 0</div>
            </div>
        </div>
        <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Total Students</h3>
                <i class="fas fa-user-graduate h-4 w-4 text-blue-500"></i>
            </div>
            <div class="p-6 pt-0">
                <!-- Initial value will be updated via AJAX -->
                <div class="text-2xl font-bold" id="totalStudents">0</div>
            </div>
        </div>
    </div>

    <!-- Tabbed Reports -->
    <div class="rounded-lg border border-border bg-card text-card-foreground shadow-sm">
        <div class="flex flex-col space-y-1.5 p-6 pb-4">
            <h3 class="font-semibold leading-none tracking-tight">Revenue Reports</h3>
        </div>
        <div class="p-6 pt-0">
            <!-- Tabs Navigation -->
            <div class="w-full mb-6">
                <div class="inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground">
                    <button
                        class="nav-tab inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-background text-foreground shadow-sm"
                        data-tab="batch-tab">
                        Revenue by Batch
                    </button>
                    <button
                        class="nav-tab inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-background/50 hover:text-foreground"
                        data-tab="course-tab">
                        Revenue by Course
                    </button>
                </div>
            </div>

            <!-- Batch Revenue Tab -->
            <div class="tab-content block" id="batch-tab">
                <div class="w-full overflow-auto">
                    <table class="w-full text-sm text-left" id="batchRevenueTable">
                        <thead class="bg-muted/50 text-muted-foreground font-medium">
                            <tr>
                                <th class="px-4 py-3">Batch</th>
                                <th class="px-4 py-3">Total Revenue</th>
                                <th class="px-4 py-3">Received Payment</th>
                                <th class="px-4 py-3">Pending Payment</th>
                                <th class="px-4 py-3">Student Count</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                            {% for item in batch_revenue %}
                            <tr class="hover:bg-muted/50 transition-colors">
                                <td class="px-4 py-3 font-medium">{{ item.batch__batch_number|default:"N/A" }}</td>
                                <td class="px-4 py-3">Rs. {{ item.total_revenue|default:0|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">Rs. {{ item.received_payment|default:0|floatformat:0|intcomma }}
                                </td>
                                <td class="px-4 py-3">Rs. {{ item.pending_payment|default:0|floatformat:0|intcomma }}
                                </td>
                                <td class="px-4 py-3">{{ item.student_count }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-muted-foreground">
                                    <div class="flex flex-col items-center justify-center gap-2">
                                        <i class="fas fa-search text-xl opacity-50"></i>
                                        <p class="text-sm font-medium">No revenue data found matching the filter
                                            criteria</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Total Row -->
                            {% if batch_revenue %}
                            <tr class="bg-muted/50 font-bold border-t-2 border-border">
                                <td class="px-4 py-3">TOTAL</td>
                                <td class="px-4 py-3">Rs. {{ batch_total_revenue|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">Rs. {{ batch_received_payment|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">Rs. {{ batch_pending_payment|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">{{ batch_student_count }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Course Revenue Tab -->
            <div class="tab-content hidden" id="course-tab">
                <div class="w-full overflow-auto">
                    <table class="w-full text-sm text-left" id="courseRevenueTable">
                        <thead class="bg-muted/50 text-muted-foreground font-medium">
                            <tr>
                                <th class="px-4 py-3">Course</th>
                                <th class="px-4 py-3">Total Revenue</th>
                                <th class="px-4 py-3">Received Payment</th>
                                <th class="px-4 py-3">Pending Payment</th>
                                <th class="px-4 py-3">Student Count</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                            {% for item in course_revenue %}
                            <tr class="hover:bg-muted/50 transition-colors">
                                <td class="px-4 py-3 font-medium">{{ item.courses__name|default:"N/A" }}</td>
                                <td class="px-4 py-3">Rs. {{ item.total_revenue|default:0|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">Rs. {{ item.received_payment|default:0|floatformat:0|intcomma }}
                                </td>
                                <td class="px-4 py-3">Rs. {{ item.pending_payment|default:0|floatformat:0|intcomma }}
                                </td>
                                <td class="px-4 py-3">{{ item.student_count }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-muted-foreground">
                                    <div class="flex flex-col items-center justify-center gap-2">
                                        <i class="fas fa-search text-xl opacity-50"></i>
                                        <p class="text-sm font-medium">No revenue data found matching the filter
                                            criteria</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Total Row -->
                            {% if course_revenue %}
                            <tr class="bg-muted/50 font-bold border-t-2 border-border">
                                <td class="px-4 py-3">TOTAL</td>
                                <td class="px-4 py-3">Rs. {{ course_total_revenue|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">Rs. {{ course_received_payment|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">Rs. {{ course_pending_payment|floatformat:0|intcomma }}</td>
                                <td class="px-4 py-3">{{ course_student_count }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize date pickers without auto-submit
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true
        });

        // Track filter values
        let currentFilters = {
            batch: document.getElementById('batch').value,
            course: document.getElementById('course').value,
            start_date: document.getElementById('start_date').value,
            end_date: document.getElementById('end_date').value
        };

        // Function to update the report data via AJAX
        function updateReportData() {
            // Show loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');

            // Get current filter values
            const batch = document.getElementById('batch').value;
            const course = document.getElementById('course').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            // Build query string
            const queryString = `batch=${batch}&course=${course}&start_date=${startDate}&end_date=${endDate}`;

            // Make AJAX request
            fetch(`{% url 'report_revenue_ajax' %}?${queryString}`)
                .then(response => response.json())
                .then(data => {
                    // Update the report data on the page
                    updateReportUI(data);

                    // Update current filters
                    currentFilters = {
                        batch: batch,
                        course: course,
                        start_date: startDate,
                        end_date: endDate
                    };

                    // Hide loading indicator
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                })
                .catch(error => {
                    console.error('Error fetching report data:', error);
                    // Hide loading indicator
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                });
        }

        // Function to update the UI with new report data
        function updateReportUI(data) {
            // Update summary cards with the filtered data totals
            document.getElementById('totalRevenue').textContent = formatCurrency(data.batch_total_revenue);
            document.getElementById('receivedPayment').textContent = formatCurrency(data.batch_received_payment);
            document.getElementById('pendingPayment').textContent = formatCurrency(data.batch_pending_payment);
            document.getElementById('totalStudents').textContent = data.batch_student_count;

            // Update batch revenue table
            const batchTableBody = document.getElementById('batchRevenueTable').querySelector('tbody');
            batchTableBody.innerHTML = '';

            if (data.batch_revenue && data.batch_revenue.length > 0) {
                // Add data rows
                data.batch_revenue.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-muted/50 transition-colors';
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium">${item.batch__batch_number || 'N/A'}</td>
                        <td class="px-4 py-3">${formatCurrency(item.total_revenue)}</td>
                        <td class="px-4 py-3">${formatCurrency(item.received_payment)}</td>
                        <td class="px-4 py-3">${formatCurrency(item.pending_payment)}</td>
                        <td class="px-4 py-3">${item.student_count}</td>
                    `;
                    batchTableBody.appendChild(row);
                });

                // Add batch total row
                const batchTotalRow = document.createElement('tr');
                batchTotalRow.className = 'bg-muted/50 font-bold border-t-2 border-border';
                batchTotalRow.innerHTML = `
                    <td class="px-4 py-3">TOTAL</td>
                    <td class="px-4 py-3">${formatCurrency(data.batch_total_revenue)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.batch_received_payment)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.batch_pending_payment)}</td>
                    <td class="px-4 py-3">${data.batch_student_count}</td>
                `;
                batchTableBody.appendChild(batchTotalRow);
            } else {
                // No data message
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-muted-foreground">
                        <div class="flex flex-col items-center justify-center gap-2">
                            <i class="fas fa-search text-xl opacity-50"></i>
                            <p class="text-sm font-medium">No revenue data found matching the filter criteria</p>
                        </div>
                    </td>`;
                batchTableBody.appendChild(noDataRow);
            }

            // Update course revenue table
            const courseTableBody = document.getElementById('courseRevenueTable').querySelector('tbody');
            courseTableBody.innerHTML = '';

            if (data.course_revenue && data.course_revenue.length > 0) {
                // Add data rows
                data.course_revenue.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-muted/50 transition-colors';
                    row.innerHTML = `
                        <td class="px-4 py-3 font-medium">${item.courses__name || 'N/A'}</td>
                        <td class="px-4 py-3">${formatCurrency(item.total_revenue)}</td>
                        <td class="px-4 py-3">${formatCurrency(item.received_payment)}</td>
                        <td class="px-4 py-3">${formatCurrency(item.pending_payment)}</td>
                        <td class="px-4 py-3">${item.student_count}</td>
                    `;
                    courseTableBody.appendChild(row);
                });

                // Add course total row
                const courseTotalRow = document.createElement('tr');
                courseTotalRow.className = 'bg-muted/50 font-bold border-t-2 border-border';
                courseTotalRow.innerHTML = `
                    <td class="px-4 py-3">TOTAL</td>
                    <td class="px-4 py-3">${formatCurrency(data.course_total_revenue)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.course_received_payment)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.course_pending_payment)}</td>
                    <td class="px-4 py-3">${data.course_student_count}</td>
                `;
                courseTableBody.appendChild(courseTotalRow);
            } else {
                // No data message
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-muted-foreground">
                        <div class="flex flex-col items-center justify-center gap-2">
                            <i class="fas fa-search text-xl opacity-50"></i>
                            <p class="text-sm font-medium">No revenue data found matching the filter criteria</p>
                        </div>
                    </td>`;
                courseTableBody.appendChild(noDataRow);
            }
        }

        // Helper function to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-PK', {
                style: 'currency',
                currency: 'PKR',
                minimumFractionDigits: 0
            }).format(value);
        }

        // Add event listeners to all filter inputs
        document.querySelectorAll('#batch, #course').forEach(input => {
            input.addEventListener('change', function () {
                // Update immediately when batch or course changes
                updateReportData();
            });
        });

        // Add event listeners to date inputs with a delay
        document.querySelectorAll('#start_date, #end_date').forEach(input => {
            input.addEventListener('change', function () {
                // Add a delay to allow user to select both dates before updating
                setTimeout(updateReportData, 500);
            });
        });

        // Export to Excel button
        document.getElementById('exportExcel').addEventListener('click', function () {
            const form = document.getElementById('filterForm');
            const exportInput = document.createElement('input');
            exportInput.type = 'hidden';
            exportInput.name = 'export';
            exportInput.value = 'excel';
            form.appendChild(exportInput);
            form.submit();
            form.removeChild(exportInput);
        });

        // Reset filters button
        document.getElementById('resetFilters').addEventListener('click', function () {
            window.location.href = '{% url "report_revenue" %}';
        });

        // Tab switching logic
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                // Get all tabs
                const tabs = document.querySelectorAll('.nav-tab');

                // Reset styling for all tabs
                tabs.forEach(t => {
                    t.className = 'nav-tab inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-background/50 hover:text-foreground';
                });

                // Set active styling for clicked tab
                this.className = 'nav-tab inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-background text-foreground shadow-sm';

                // Hide all contents
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('block');
                    c.classList.add('hidden');
                });

                // Show corresponding content
                const tabId = this.getAttribute('data-tab');
                const activeContent = document.getElementById(tabId);
                activeContent.classList.remove('hidden');
                activeContent.classList.add('block');
            });
        });

        // Initial load of report data so summary cards & tables show correct values
        updateReportData();
    });
</script>
{% endblock %}